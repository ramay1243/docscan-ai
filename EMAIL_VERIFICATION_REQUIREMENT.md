# Требование подтверждения email для бесплатного анализа

## Описание системы

После регистрации пользователь **НЕ МОЖЕТ** использовать бесплатный анализ до тех пор, пока не подтвердит свой email адрес.

---

## Текущий процесс регистрации

1. **Пользователь регистрируется:**
   - Вводит email и пароль
   - Создается аккаунт с параметрами:
     - `email_verified = False` (почта не подтверждена)
     - `free_analysis_used = False` (бесплатный анализ еще не использован)
   - Отправляется письмо с ссылкой для подтверждения email
   - Пользователь авторизуется в системе

2. **Пользователь пытается сделать анализ:**
   - ❌ **БЛОКИРОВКА**: Система проверяет `email_verified`
   - Если `email_verified = False` → возвращается ошибка с требованием подтвердить email
   - Пользователь видит сообщение: *"Для использования бесплатного анализа необходимо подтвердить email. Проверьте почту и перейдите по ссылке из письма."*

3. **Пользователь подтверждает email:**
   - Переходит по ссылке из письма
   - `email_verified` устанавливается в `True`
   - Теперь пользователь может использовать бесплатный анализ

4. **Пользователь использует бесплатный анализ:**
   - После подтверждения email пользователь может сделать анализ
   - После первого анализа `free_analysis_used` устанавливается в `True`
   - Дальнейшие анализы доступны только при покупке тарифа

---

## Техническая реализация

### 1. Проверка в `/api/analyze` (routes/api.py)

**Место проверки:** После проверки авторизации, но ДО проверки лимитов

```python
if is_authenticated:
    user = app.user_manager.get_user(user_id)
    
    # НОВАЯ ПРОВЕРКА: Для бесплатного тарифа требуем подтверждение email
    if user.plan == 'free' and not user.email_verified:
        return jsonify({
            'success': False,
            'error': 'Для использования бесплатного анализа необходимо подтвердить email адрес.',
            'email_verification_required': True,
            'message': 'Проверьте почту и перейдите по ссылке из письма для подтверждения.'
        }), 403
```

### 2. Логика работы

**Для зарегистрированных пользователей с бесплатным тарифом:**

1. ✅ Пользователь авторизован (`is_authenticated = True`)
2. ✅ План = `'free'`
3. ❌ **ПРОВЕРКА**: `email_verified = False` → **БЛОКИРОВКА**
4. ✅ После подтверждения: `email_verified = True` → **РАЗРЕШЕНО**
5. ✅ Проверка `free_analysis_used`:
   - Если `False` → можно сделать анализ
   - Если `True` → анализ уже использован, нужен платный тариф

**Для незарегистрированных пользователей (гостей):**
- Ограничение **НЕ применяется** (они работают по IP-лимитам)
- Гости могут делать 1 анализ без регистрации

**Для платных тарифов:**
- Ограничение **НЕ применяется** (они уже подтвердили email при регистрации или купили тариф)
- Проверяется только `available_analyses > 0`

---

## Пользовательский опыт (UX)

### Сценарий 1: Пользователь регистрируется и сразу пытается сделать анализ

1. **Регистрация** → "Регистрация успешна! Проверьте email для подтверждения."
2. **Попытка анализа** → Показывается сообщение:
   ```
   ⚠️ Для использования бесплатного анализа необходимо подтвердить email адрес.
   
   Мы отправили письмо на ваш email. Пожалуйста:
   1. Проверьте почту (включая папку "Спам")
   2. Перейдите по ссылке из письма
   3. После подтверждения вы сможете использовать бесплатный анализ
   
   [Кнопка: Отправить письмо повторно]
   ```
3. **После подтверждения** → Пользователь может сделать анализ

### Сценарий 2: Пользователь подтверждает email, но не делает анализ сразу

1. **Регистрация** → Письмо отправлено
2. **Подтверждение email** → `email_verified = True`
3. **Попытка анализа (через несколько дней)** → ✅ Разрешено (если `free_analysis_used = False`)

### Сценарий 3: Пользователь покупает тариф без подтверждения email

- **НЕВОЗМОЖНО**: Для покупки тарифа пользователь должен быть авторизован
- При авторизации система может проверить `email_verified`, но для платных тарифов это не критично
- **РЕКОМЕНДАЦИЯ**: Требовать подтверждение email для всех операций (включая покупку тарифа)

---

## API ответы

### Ошибка при попытке анализа без подтверждения email:

```json
{
  "success": false,
  "error": "Для использования бесплатного анализа необходимо подтвердить email адрес.",
  "email_verification_required": true,
  "message": "Проверьте почту и перейдите по ссылке из письма для подтверждения."
}
```

**HTTP статус:** `403 Forbidden`

### Успешный ответ после подтверждения:

```json
{
  "success": true,
  "filename": "document.pdf",
  "result": { ... },
  "user_id": "abc12345"
}
```

---

## Проверка статуса в `/api/usage`

Эндпоинт `/api/usage` должен возвращать информацию о статусе подтверждения email:

```json
{
  "user_id": "abc12345",
  "plan": "free",
  "plan_name": "Бесплатный",
  "free_analysis_used": false,
  "email_verified": false,  // ← НОВОЕ ПОЛЕ
  "remaining": 1,
  "is_registered": true,
  "email_verification_required": true  // ← НОВОЕ ПОЛЕ
}
```

---

## Фронтенд (JavaScript)

### Проверка перед отправкой файла:

```javascript
// Перед отправкой запроса на анализ
if (user.plan === 'free' && !user.email_verified) {
    showError('Для использования бесплатного анализа необходимо подтвердить email. Проверьте почту и перейдите по ссылке из письма.');
    return;
}
```

### Обработка ответа от сервера:

```javascript
if (response.email_verification_required) {
    showEmailVerificationModal();
    // Показать модальное окно с инструкциями
}
```

---

## Преимущества системы

1. ✅ **Защита от спама**: Требование подтверждения email снижает количество фейковых регистраций
2. ✅ **Валидные контакты**: Гарантирует, что у пользователя есть рабочий email для коммуникации
3. ✅ **Мотивация подтверждения**: Пользователь заинтересован подтвердить email, чтобы получить доступ к анализу
4. ✅ **Улучшение конверсии**: После подтверждения email пользователь более вовлечен в сервис

---

## Исключения и особые случаи

### 1. Пользователь потерял письмо
- **Решение**: Добавить кнопку "Отправить письмо повторно" в личном кабинете
- **Реализация**: Эндпоинт `/api/resend-verification-email`

### 2. Пользователь изменил email
- **Решение**: При смене email `email_verified` сбрасывается в `False`
- Требуется повторное подтверждение нового email

### 3. Пользователь купил тариф до подтверждения email
- **Вариант А**: Разрешить покупку, но требовать подтверждение для бесплатного анализа
- **Вариант Б**: Требовать подтверждение email для всех операций (рекомендуется)

---

## Миграция существующих пользователей

Для пользователей, которые уже зарегистрированы, но не подтвердили email:

- **Вариант 1**: Требовать подтверждение при следующем входе
- **Вариант 2**: Если `free_analysis_used = True`, разрешить работу (они уже использовали анализ)
- **Вариант 3**: Отправить письмо с напоминанием о необходимости подтверждения

**Рекомендация**: Вариант 2 + отправка напоминания

---

## Логирование

Все попытки использования анализа без подтверждения email должны логироваться:

```
⚠️ Попытка использования бесплатного анализа без подтверждения email: user_id=abc12345, email=user@example.com
```

Это поможет отслеживать:
- Сколько пользователей не подтверждают email
- Эффективность системы подтверждения
- Необходимость улучшения UX

---

## Итоговая схема работы

```
┌─────────────────┐
│  Регистрация    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ email_verified  │ = False
│ free_analysis   │ = False
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Письмо отправлено│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Попытка анализа │
└────────┬────────┘
         │
         ▼
    ┌────────┐
    │ email_ │
    │verified│ = False?
    └───┬────┘
        │
        ├─ ДА → ❌ БЛОКИРОВКА
        │        "Подтвердите email"
        │
        └─ НЕТ → ✅ РАЗРЕШЕНО
                 Проверка free_analysis_used
```

---

## Дата создания документа

**Создано:** 2025-01-XX  
**Автор:** AI Assistant  
**Статус:** Описание системы (требуется реализация)

